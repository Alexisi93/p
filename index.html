<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terraria Web Launcher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <style>
        body { background-color: #050505; color: #e2e8f0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        .launcher-bg { background: radial-gradient(circle at 50% 0%, #1a2e25 0%, #050505 70%); }
        .glass-panel { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .launcher-sidebar { background: rgba(0, 0, 0, 0.4); border-right: 1px solid rgba(255,255,255,0.05); }
        kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
        
        /* Custom Scrollbar for ZIP logs if needed */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 launcher-bg">

    <!-- MAIN LAUNCHER UI -->
    <div id="launcherUI" class="glass-panel rounded-2xl shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col md:flex-row transition-all duration-500 relative z-10 border-t border-t-emerald-500/30">
        
        <!-- Sidebar -->
        <div class="launcher-sidebar w-full md:w-64 p-6 flex flex-col justify-between">
            <div>
                <h1 class="text-3xl font-black tracking-tight text-transparent bg-clip-text bg-gradient-to-b from-green-400 to-emerald-700 drop-shadow-sm mb-1">TERRARIA</h1>
                <p class="text-xs text-emerald-400/80 font-mono tracking-widest font-bold mb-8">WEB ENGINE</p>
                
                <div class="space-y-4">
                    <div class="flex items-center gap-3 text-sm text-gray-300">
                        <div id="statusDot" class="w-2.5 h-2.5 rounded-full bg-yellow-500 animate-pulse"></div>
                        <span id="statusMsg" class="font-medium">Initializing...</span>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 pt-6 border-t border-white/5">
                <p class="text-xs text-gray-500 font-mono">Build v2.0.0-launcher</p>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 p-8 md:p-10 relative flex flex-col justify-center min-h-[400px]">
            
            <!-- Error Box -->
            <div id="errorBox" class="hidden absolute top-0 left-0 right-0 bg-red-900/90 border-b border-red-600 p-4 text-sm text-red-100 shadow-xl z-20 backdrop-blur-md">
                <p class="font-bold flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    System Error
                </p>
                <p id="errorText" class="mt-1 opacity-90">Something went wrong.</p>
            </div>

            <!-- STEP 1: Service Worker Setup/Update -->
            <div id="setupBox" class="hidden space-y-6 animate-fade-in">
                <div>
                    <h2 class="text-2xl font-bold text-white mb-2">Engine Update Required</h2>
                    <p class="text-gray-400 text-sm leading-relaxed">The internal server requires a critical update to handle game assets (Dotnet/Blazor). Please sync the latest Service Worker.</p>
                </div>
                
                <div class="bg-black/30 p-5 rounded-xl border border-white/5 space-y-3">
                    <ol class="list-decimal ml-4 text-sm text-gray-300 space-y-1.5 font-medium">
                        <li>Download the <span class="text-emerald-400">sw.js</span> file below.</li>
                        <li>Upload it to your GitHub repository to replace the old one.</li>
                        <li>Wait ~60 seconds for GitHub to process it.</li>
                        <li>Click <b>Refresh & Verify</b>.</li>
                    </ol>
                </div>

                <div class="flex gap-3">
                    <button onclick="downloadSW()" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-lg hover:shadow-emerald-900/50 flex justify-center items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Download sw.js
                    </button>
                    <button onclick="window.location.reload()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg text-sm">
                        Refresh & Verify
                    </button>
                </div>
                <!-- Forced Bypass for advanced users -->
                <button onclick="forceContinue()" class="text-xs text-gray-500 hover:text-gray-300 underline underline-offset-2">Skip check (I already updated it)</button>
            </div>

            <!-- STEP 2: Upload ZIP -->
            <div id="uploadBox" class="hidden space-y-6 animate-fade-in">
                <div>
                    <h2 class="text-2xl font-bold text-white mb-2">Install Game Assets</h2>
                    <p class="text-gray-400 text-sm leading-relaxed">Select your packaged game data (ZIP/TAR). Files are extracted directly into your browser's secure local cache.</p>
                </div>
                
                <label class="block w-full bg-slate-800/50 hover:bg-slate-800 cursor-pointer text-white font-bold py-8 px-4 rounded-xl transition-all border-2 border-dashed border-slate-600 hover:border-emerald-500 group">
                    <div class="flex flex-col items-center justify-center gap-3">
                        <div class="p-3 bg-slate-700 rounded-full group-hover:bg-emerald-500/20 group-hover:text-emerald-400 transition-colors">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        </div>
                        <span class="text-lg">Select Asset Archive</span>
                        <span class="text-xs text-gray-500 font-normal">Supports .zip containing web build files</span>
                    </div>
                    <input type="file" id="zipInput" accept=".zip" class="hidden">
                </label>

                <!-- Progress Bar -->
                <div id="progressContainer" class="hidden mt-4 space-y-2">
                    <div class="flex justify-between text-xs font-mono text-gray-400">
                        <span id="progressText">Extracting files...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="w-full bg-black/50 rounded-full h-2 overflow-hidden border border-white/5">
                        <div id="progressBar" class="bg-emerald-500 h-full rounded-full transition-all duration-100 ease-out" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- STEP 3: Play & Settings -->
            <div id="playBox" class="hidden space-y-8 animate-fade-in flex flex-col items-center text-center">
                
                <div class="w-24 h-24 bg-emerald-900/30 rounded-full flex items-center justify-center border border-emerald-500/30 shadow-[0_0_30px_rgba(16,185,129,0.2)] mb-2">
                    <svg class="w-10 h-10 text-emerald-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                </div>

                <div>
                    <h2 class="text-2xl font-bold text-white mb-1">Ready to Play</h2>
                    <p class="text-emerald-400/80 text-sm font-medium">Assets verified in local cache.</p>
                </div>
                
                <button onclick="launchGame()" class="w-full max-w-sm bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 px-6 rounded-xl transition-all shadow-[0_0_20px_rgba(16,185,129,0.3)] hover:shadow-[0_0_30px_rgba(16,185,129,0.5)] hover:-translate-y-1 text-lg tracking-wide">
                    LAUNCH ENGINE
                </button>
                
                <div class="w-full max-w-sm bg-black/40 p-4 rounded-lg border border-white/5 text-left flex items-start gap-3">
                    <svg class="w-5 h-5 text-gray-400 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <div>
                        <p class="text-xs text-gray-400 uppercase tracking-wider font-bold mb-1">In-Game Menu</p>
                        <p class="text-sm text-gray-300">Press <kbd class="bg-slate-800 border border-slate-600 px-1.5 py-0.5 rounded shadow-sm text-white">Ctrl</kbd> + <kbd class="bg-slate-800 border border-slate-600 px-1.5 py-0.5 rounded shadow-sm text-white">E</kbd> + <kbd class="bg-slate-800 border border-slate-600 px-1.5 py-0.5 rounded shadow-sm text-white">A</kbd> simultaneously to open settings, toggle fullscreen, or exit.</p>
                    </div>
                </div>

                <button onclick="clearData()" class="text-sm text-red-400 hover:text-red-300 font-medium underline underline-offset-4 decoration-red-900 hover:decoration-red-400 transition-colors">
                    Uninstall Game Files
                </button>
            </div>

            <!-- Disclaimer Footer -->
            <div class="absolute bottom-4 left-0 right-0 text-center px-8 opacity-60">
                <p class="text-[10px] text-gray-500 font-medium">
                    DISCLAIMER: This tool is an engine wrapper. You must legally own Terraria to play. Piracy is not supported. All game assets belong to Re-Logic.
                </p>
            </div>
        </div>
    </div>

    <!-- GAME CONTAINER -->
    <div id="gameContainer" class="hidden fixed inset-0 w-full h-full bg-black z-40 flex flex-col">
        <!-- The actual game iframe container -->
        <div id="iframeContainer" class="w-full h-full border-none flex-grow bg-black relative">
        </div>

        <!-- In-Game Settings Menu Overlay -->
        <div id="gameMenuOverlay" class="hidden absolute inset-0 bg-black/80 backdrop-blur-md z-[100] flex items-center justify-center transition-opacity duration-200">
            <div class="bg-slate-900 border border-emerald-500/20 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">
                <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-b from-green-400 to-emerald-700 mb-1">ENGINE PAUSED</h2>
                <p class="text-gray-500 text-xs mb-8 font-mono">v2.0.0-launcher</p>
                
                <button onclick="toggleFullscreen()" class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-600 text-white font-bold py-3 px-4 rounded-xl mb-3 transition-all flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                    Toggle Fullscreen
                </button>
                
                <button onclick="exitGame()" class="w-full bg-red-900/50 hover:bg-red-800 border border-red-700 text-white font-bold py-3 px-4 rounded-xl mb-6 transition-all flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Save & Exit to Desktop
                </button>
                
                <button onclick="toggleGameMenu()" class="text-gray-400 hover:text-white font-semibold text-sm px-4 py-2 rounded-lg hover:bg-white/5 transition-colors">
                    Resume Game (Esc)
                </button>
            </div>
        </div>
    </div>

    <script>
        // MUST match the SW.js EXACTLY
        const EXPECTED_VERSION = 'v2.0.0-launcher';

        // Update the dot UI helper
        function setStatus(msg, type = 'info') {
            document.getElementById('statusMsg').innerText = msg;
            const dot = document.getElementById('statusDot');
            dot.className = 'w-2.5 h-2.5 rounded-full animate-pulse ' + 
                (type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-emerald-500' : 'bg-yellow-500');
        }

        // --- Forced Download String Generation ---
        const swCode = `// v2.0.0-launcher
const SW_VERSION = 'v2.0.0-launcher';
importScripts('https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js');

self.addEventListener('install', e => self.skipWaiting());
self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));

self.addEventListener('message', event => {
    if (event.data && event.data.type === 'CHECK_VERSION') {
        event.ports[0].postMessage({ version: SW_VERSION });
    }
});

self.addEventListener('fetch', e => {
    if (e.request.method !== 'GET') return;
    const url = new URL(e.request.url);
    if (!url.protocol.startsWith('http')) return;

    e.respondWith((async () => {
        const path = url.pathname.split('/').pop();
        if (path === 'sw.js') return fetch(e.request);

        if (path === 'virtual-game.html') {
            try {
                const keys = await localforage.keys();
                const htmlKey = keys.find(k => k === 'terraria.html') || keys.find(k => k === 'index.html') || keys.find(k => k.endsWith('.html'));
                if (htmlKey) {
                    const fileData = await localforage.getItem(htmlKey);
                    return new Response(fileData, {
                        headers: {
                            'Content-Type': 'text/html',
                            'Cross-Origin-Embedder-Policy': 'require-corp',
                            'Cross-Origin-Opener-Policy': 'same-origin',
                            'Cache-Control': 'no-cache, no-store, must-revalidate'
                        }
                    });
                }
                return new Response("<h2 style='color:white; font-family:sans-serif; text-align:center; margin-top:50px;'>Game HTML not found. Please click 'Exit Game' and re-extract the ZIP.</h2>", { status: 404, headers: {'Content-Type': 'text/html'} });
            } catch(err) {
                return new Response("Error reading storage database.", { status: 500 });
            }
        }

        if (path && path !== 'index.html' && path !== '') {
            try {
                const fileData = await localforage.getItem(path);
                if (fileData) {
                    const ext = path.split('.').pop().toLowerCase();
                    const mimeTypes = { 'html':'text/html', 'js':'application/javascript', 'mjs':'application/javascript', 'json':'application/json', 'wasm':'application/wasm', 'tar':'application/x-tar', 'zip':'application/zip', 'png':'image/png', 'jpg':'image/jpeg', 'css':'text/css', 'txt':'text/plain', 'dll':'application/octet-stream', 'dat':'application/octet-stream', 'blat':'application/octet-stream', 'br':'application/brotli', 'gz':'application/gzip', 'data':'application/octet-stream' };
                    return new Response(fileData, {
                        headers: {
                            'Content-Type': mimeTypes[ext] || 'application/octet-stream',
                            'Cross-Origin-Embedder-Policy': 'require-corp',
                            'Cross-Origin-Opener-Policy': 'same-origin',
                            'Cache-Control': 'public, max-age=3600'
                        }
                    });
                }
            } catch(err) { console.error('IDB Read Error:', err); }
        }

        try {
            const res = await fetch(e.request);
            if (res.status === 0) return res; 
            const headers = new Headers(res.headers);
            headers.set('Cross-Origin-Embedder-Policy', 'require-corp');
            headers.set('Cross-Origin-Opener-Policy', 'same-origin');
            return new Response(res.body, { status: res.status, statusText: res.statusText, headers: headers });
        } catch(err) { return fetch(e.request); }
    })());
});`;

        function downloadSW() {
            const a = document.createElement('a');
            a.href = 'data:application/javascript;charset=utf-8,' + encodeURIComponent(swCode);
            a.download = 'sw.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function forceContinue() {
            document.getElementById('setupBox').classList.add('hidden');
            checkHeadersAndContinue();
        }

        async function checkHeadersAndContinue() {
            if (!window.crossOriginIsolated) {
                let reloads = parseInt(sessionStorage.getItem('sw_reload_count') || '0');
                if (reloads < 3) {
                    sessionStorage.setItem('sw_reload_count', reloads + 1);
                    setStatus("Applying secure engine headers...", "info");
                    setTimeout(() => window.location.reload(), 800);
                } else {
                    setStatus("Security bypass failed. Check browser settings.", "error");
                }
                return;
            }

            sessionStorage.removeItem('sw_reload_count');
            setStatus("Engine Ready", "success");
            
            const isInstalled = await localforage.getItem('is_installed');
            if (isInstalled) {
                document.getElementById('playBox').classList.remove('hidden');
            } else {
                document.getElementById('uploadBox').classList.remove('hidden');
            }
        }

        function showError(msg) {
            const errBox = document.getElementById('errorBox');
            const errText = document.getElementById('errorText');
            errText.innerText = msg;
            errBox.classList.remove('hidden');
            setStatus("System Error", "error");
            
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('zipInput').parentElement.classList.remove('hidden');
        }

        // --- Application Logic ---
        document.addEventListener('DOMContentLoaded', async () => {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').then(async (reg) => {
                    
                    // Wait for service worker to be active before checking version
                    if (reg.installing) {
                        await new Promise(resolve => {
                            reg.installing.addEventListener('statechange', e => {
                                if (e.target.state === 'activated') resolve();
                            });
                        });
                    }

                    let needsUpdate = false;
                    try {
                        const checkSWVersion = () => {
                            return new Promise(resolve => {
                                if (!navigator.serviceWorker.controller) {
                                    resolve(true); // Need reload/update
                                    return;
                                }
                                const channel = new MessageChannel();
                                channel.port1.onmessage = (e) => {
                                    if (e.data && e.data.version === EXPECTED_VERSION) {
                                        resolve(false);
                                    } else {
                                        console.log(`Version mismatch: expected ${EXPECTED_VERSION}, got ${e.data.version}`);
                                        resolve(true);
                                    }
                                };
                                navigator.serviceWorker.controller.postMessage({ type: 'CHECK_VERSION' }, [channel.port2]);
                                setTimeout(() => resolve(true), 1500); // timeout
                            });
                        };

                        needsUpdate = await checkSWVersion();
                        
                        if (needsUpdate) {
                            // Double check via fetch just in case messaging failed
                            const swFetch = await fetch('sw.js?t=' + Date.now(), { cache: 'no-store' });
                            if (swFetch.ok) {
                                const swText = await swFetch.text();
                                if (swText.includes(EXPECTED_VERSION)) needsUpdate = false;
                            }
                        }
                    } catch(e) { needsUpdate = true; }

                    if (needsUpdate) {
                        document.getElementById('setupBox').classList.remove('hidden');
                        setStatus("Update Required", "error");
                        return; 
                    }

                    checkHeadersAndContinue();

                }).catch(err => {
                    document.getElementById('setupBox').classList.remove('hidden');
                    setStatus("Service Worker Blocked", "error");
                });
            } else {
                setStatus("Incompatible Browser", "error");
            }

            // ZIP Extraction Logic
            document.getElementById('zipInput').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                document.getElementById('errorBox').classList.add('hidden');
                const pContainer = document.getElementById('progressContainer');
                const pBar = document.getElementById('progressBar');
                const pText = document.getElementById('progressText');
                const pPercent = document.getElementById('progressPercent');
                
                pContainer.classList.remove('hidden');
                document.getElementById('zipInput').parentElement.classList.add('hidden'); 
                setStatus("Extracting...", "info");
                
                try {
                    const zip = await JSZip.loadAsync(file);
                    // Filter out directories and hidden mac files
                    const files = Object.keys(zip.files).filter(f => !zip.files[f].dir && !f.includes('__MACOSX') && !f.includes('.DS_Store'));
                    
                    let hasHtml = false;
                    let i = 0;
                    
                    for (const filename of files) {
                        i++;
                        const cleanName = filename.split('/').pop(); 
                        if (cleanName.endsWith('.html')) hasHtml = true;
                        
                        const percent = Math.floor((i / files.length) * 100);
                        pText.innerText = cleanName;
                        pPercent.innerText = percent + '%';
                        pBar.style.width = percent + '%';
                        
                        const data = await zip.files[filename].async('arraybuffer');
                        
                        try {
                            await localforage.setItem(cleanName, data);
                        } catch (storageErr) {
                            if (storageErr.name === 'QuotaExceededError' || (storageErr.message && storageErr.message.includes('Quota'))) {
                                throw new Error("Disk Full. Free up space on your device or leave Incognito Mode.");
                            }
                            throw storageErr; 
                        }
                    }
                    
                    if (!hasHtml) {
                        throw new Error("Invalid Archive: No HTML engine file found inside.");
                    }
                    
                    await localforage.setItem('is_installed', true);
                    setStatus("Extraction Complete", "success");
                    pText.innerText = 'Finalizing...';
                    
                    setTimeout(() => {
                        document.getElementById('uploadBox').classList.add('hidden');
                        document.getElementById('playBox').classList.remove('hidden');
                    }, 1000);
                    
                } catch (err) {
                    showError(err.message || "Failed to process the archive.");
                } finally {
                    e.target.value = ''; 
                }
            });
        });

        // --- Game Container & Shortcut Controls ---
        let keysTracker = new Set();

        function handleKeyDown(e) {
            keysTracker.add(e.key.toLowerCase());
            
            if (e.ctrlKey && keysTracker.has('e') && keysTracker.has('a')) {
                e.preventDefault(); 
                toggleGameMenu();
                keysTracker.clear(); 
            }

            if (e.key === 'Escape') {
                const menu = document.getElementById('gameMenuOverlay');
                if (!menu.classList.contains('hidden')) {
                    toggleGameMenu();
                }
            }
        }

        function handleKeyUp(e) {
            keysTracker.delete(e.key.toLowerCase());
        }

        function attachShortcutListeners(targetWindow) {
            targetWindow.addEventListener('keydown', handleKeyDown, true);
            targetWindow.addEventListener('keyup', handleKeyUp, true);
        }
        
        attachShortcutListeners(window);

        function launchGame() {
            document.getElementById('launcherUI').classList.add('hidden');
            document.body.classList.remove('launcher-bg');
            document.getElementById('gameContainer').classList.remove('hidden');
            document.getElementById('gameMenuOverlay').classList.add('hidden');
            
            const container = document.getElementById('iframeContainer');
            container.innerHTML = '<iframe id="gameFrame" class="w-full h-full border-none flex-grow bg-black" allow="fullscreen; autoplay; keyboard-map; cross-origin-isolated" src="virtual-game.html"></iframe>';

            const frame = document.getElementById('gameFrame');
            frame.onload = () => {
                try {
                    attachShortcutListeners(frame.contentWindow);
                } catch(err) {}
                frame.focus();
            };
        }

        function toggleGameMenu() {
            const menu = document.getElementById('gameMenuOverlay');
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                if (document.pointerLockElement) document.exitPointerLock();
            } else {
                menu.classList.add('hidden');
                const frame = document.getElementById('gameFrame');
                if (frame) frame.focus();
            }
        }

        function exitGame() {
            document.getElementById('iframeContainer').innerHTML = ''; 
            document.getElementById('gameMenuOverlay').classList.add('hidden');
            document.getElementById('gameContainer').classList.add('hidden');
            
            document.body.classList.add('launcher-bg');
            document.getElementById('launcherUI').classList.remove('hidden');
            keysTracker.clear();
            
            if (document.fullscreenElement) document.exitFullscreen();
        }

        function toggleFullscreen() {
            const container = document.getElementById('gameContainer');
            if (!document.fullscreenElement) {
                if (container.requestFullscreen) container.requestFullscreen();
                else if (container.webkitRequestFullscreen) container.webkitRequestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
            }
        }

        async function clearData() {
            if(confirm("Uninstall game assets from the browser? You will need to re-upload the ZIP to play again.")) {
                await localforage.clear();
                window.location.reload();
            }
        }
    </script>
</body>
</html>
